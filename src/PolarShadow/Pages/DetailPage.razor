@page "/detail"
@layout TopLevelLayout
@inject IStateContext _context
@inject IPolarShadow _polarShadow
@inject INavigationService _nav
@inject IMyCollectionService _myCollection
@inject IHttpFileResource _imageCache
@inject IHttpResource _httpResource
@inject IMessageService _msg;

<Layout>
    <Header>
        @if (_nav.CanBack())
        {
            <Icon Type="left" Theme="outline" OnClick="Back" Class="cursor-point-style menu-icon" />
        }
    </Header>
    <Content Class="scroll-content three-stage-layout-content">
        @if (_isLoading)
        {
            <Spin Class="horizonal-cneter"/>
        }
        else if (_detail != null)
        {
            <Space Style="width:100%" Direction="DirectionVHType.Vertical" Align="center">
                <SpaceItem>
                    <img src="@_imageUrl" alt="img" style="width:200px" @onload="ImageOnLoad" />
                </SpaceItem>
                <SpaceItem>
                    <div style="height:45px">
                        <Text Strong Class="text-auto-hidden">@_detail.Name</Text>
                    </div>
                </SpaceItem>
            </Space>
            <Space Direction="DirectionVHType.Vertical" Align="left">
                <SpaceItem>
                    <Title Level="4">简介</Title>
                    <Paragraph>@_detail.Description</Paragraph>
                </SpaceItem>
                <SpaceItem>
                    <Title Level="4">来源</Title>
                    <Text>@_detail.Site</Text>
                </SpaceItem>
                <SpaceItem>
                    <Title Level="4">资源</Title>
                    @if(_detail.Seasons != null && _detail.Seasons.Count > 0)
                    {
                        <Space Direction="DirectionVHType.Vertical">
                            @foreach (var item in _detail.Seasons)
                            {
                                <SpaceItem>
                                    <strong style="display:block">@item.Name</strong>
                                    <Space Size="@(("16", "16"))" Direction="DirectionVHType.Horizontal" Wrap>
                                        @foreach (var item in item.Episodes)
                                        {
                                            <SpaceItem>
                                                <Button Type="@ButtonType.Default" Shape="@ButtonShape.Round" OnClick="()=>EpisodeClick(item)">@item.Name</Button>
                                            </SpaceItem>
                                        }

                                    </Space>
                                </SpaceItem>
                                
                            }
                        </Space>
                        
                    }
                    
                </SpaceItem>
            </Space>
        }
        else
        {
            <Empty/>
        }
        <div Class="fixed-widgets">
            <Button Icon="@IconType.Outline.Sync" Type="@ButtonType.Primary" Shape="@ButtonShape.Circle" OnClick="Refresh"></Button>
        </div>
    </Content>
    <Footer Class="three-stage-layout-footer" Style="height:60px">
        @if (!_isCollected.HasValue) { }
        else if (_isCollected == true)
        {
            <Button Style="width:100%;height:100%" OnClick="UncollectClick">取消收藏</Button>
        }
        else
        {
            <Button Style="width:100%;height:100%" OnClick="CollectClick">收藏</Button>
        }
    </Footer>
</Layout>

@code {
    public static string _detail_parameter_Key = "detail_link";
    public static string _stateDetailKey = "state_detail";
    private VideoDetail _detail;
    private string _imageUrl;
    private bool _isLoading = true;

    private bool? _isCollected = false;

    private ListGridType grid = new ListGridType()
    {
        Gutter = 16,
        Xs = 1,
        Sm = 2,
        Md = 4,
        Lg = 4,
        Xl = 6,
        Xxl = 8
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            bool isFromCache = false;
            if (_context.TryGet(_stateDetailKey, out VideoDetail detail))
            {
                _detail = detail;
                isFromCache = true;
            }
            else if (_context.TryGet(_detail_parameter_Key, out ILink link) 
            && _polarShadow.TryGetSite(link.Site, out ISite site))
            {
                isFromCache = false;
                _detail = await site.GetDetailAsync(link);
            }

            if (_detail != null)
            {
                _isCollected = await _myCollection.HasAsync(_detail);
                if (isFromCache)
                {
                    _imageUrl = await _imageCache.CreateObjectUrlAsync(_detail.ImageSrc);
                }
                else
                {
                    var uri = new Uri(_detail.ImageSrc);
                    if (Uri.UriSchemeHttp.Equals(uri.Scheme))
                    {
                        _imageUrl = await _httpResource.CreateObjectUrlAsync(_detail.ImageSrc);
                    }
                    else
                    {
                        _imageUrl = _detail.ImageSrc;
                    }
                }
            }
        }
        catch(Exception ex)
        {
            await _msg.Error(ex.Message);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ImageOnLoad(ProgressEventArgs arg)
    {
        await _imageCache.RevokeObjectUrlAsync(_imageUrl);
    }

    private void Back()
    {
        _nav.Back();
    }

    private async Task CollectClick(MouseEventArgs arg)
    {
        await _myCollection.AddToMyCollectionAsync(_detail);
        _isCollected = true;
    }

    private async Task UncollectClick(MouseEventArgs arg)
    {
        await _myCollection.RemoveFromMyCollectionAsync(_detail.Name);
        _isCollected = false;
        _imageCache.RemoveCache(_detail.ImageSrc);
    }

    private void EpisodeClick(VideoEpisode episode)
    {
        _nav.NavigateTo("/episode", new Dictionary<string, object>
        {
            { EpisodePage.EpisodeKey, episode },
            { EpisodePage.VideoNameKey, _detail.Name }
        }, new Dictionary<string, object>
        {
            { _stateDetailKey, _detail }
        }, true);
    }

    private async Task Refresh()
    {
        try
        {
            _isLoading = true;
            if (_polarShadow.TryGetSite(_detail.Site, out ISite site))
            {
                _detail = await site.GetDetailAsync(_detail);
            }

            if (_detail != null)
            {
                if (_isCollected.HasValue && _isCollected.Value)
                {
                    _imageUrl = await _imageCache.CreateObjectUrlAsync(_detail.ImageSrc);
                    await _myCollection.AddToMyCollectionAsync(_detail);

                }
                else
                {
                    var uri = new Uri(_detail.ImageSrc);
                    if (Uri.UriSchemeHttp.Equals(uri.Scheme))
                    {
                        _imageUrl = await _httpResource.CreateObjectUrlAsync(_detail.ImageSrc);
                    }
                    else
                    {
                        _imageUrl = _detail.ImageSrc;
                    }
                }
            }
        }
        catch(Exception ex)
        {
            await _msg.Error(ex.Message);
        }
        finally
        {
            _isLoading = false;
        }

    }
}
