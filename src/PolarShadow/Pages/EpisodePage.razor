@page "/episode"
@layout TopLevelLayout
@inject IStateContext _context
@inject INavigationService _nav
@inject IMessageService _message;

<Layout>
    <Header>
        <Space Size="@("16")" Direction="DirectionVHType.Horizontal" Align="baseline">
            <SpaceItem>
                @if (_nav.CanBack())
                {
                    <Icon Type="left" Theme="outline" OnClick="()=>_nav.Back()" Class="cursor-point-style menu-icon" />
                }
            </SpaceItem>
            <SpaceItem>
                <Title Level="4">@_episode.Name</Title>
            </SpaceItem>
        </Space>
    </Header>
    <Content Class="scroll-content">
        <Space Size="@("16")" Direction="DirectionVHType.Vertical" Style="width:100%">
            @if (_episode != null && _episode.Sources != null)
            {
                foreach (var item in _episode.Sources)
                {
                    <SpaceItem>
                        <Button Type="@ButtonType.Default" Shape="@ButtonShape.Round" OnClick="()=>EpisodeLinkClick(item)" Style="width:100%">@item.SrcType.ToString()</Button>
                    </SpaceItem>
                }
            }
        </Space>
    </Content>
</Layout>

@code {
    public static readonly string EpisodeKey = "episode";
    public static readonly string VideoNameKey = "videoNameKey";
    private VideoEpisode _episode;
    private string _videoName;

    protected override void OnInitialized()
    {
        if (_context.TryGet(EpisodeKey, out object val) && val is VideoEpisode episode)
        {
            _episode = episode;
        }

        if (_context.TryGet(VideoNameKey, out object nameVal))
        {
            _videoName = nameVal.ToString();
        }
    }

    private async Task EpisodeLinkClick(VideoSource source)
    {
        switch (source.SrcType)
        {
            case SrcType.HTML:
                _nav.NavigateTo(source.Src, false, true);
                break;
            case SrcType.Magnet:
                using(var _aria2 = new Aria2Http(new Uri("http://localhost:16800/jsonrpc")))
                {
                    var request = _aria2.CreateAddUri(new string[] { source.Src }, new Aria2InputFileOption
                    {
                        Dir = @$"D:\Videos\{_videoName}"
                    });
                    var result = await _aria2.PostAsync(request);
                    if (result.IsOk())
                    {
                        await _message.Info("发送成功");
                    }
                    else if (result.IsError())
                    {
                        await _message.Error(result.Error.Message);
                    }
                    else
                    {
                        await _message.Warning(result.Result);
                    }
                }            
                break;
            default:
                break;
        }
    }
}
